name: Build and Release Conda

on:
  push:
    branches: [ master ]
  pull_request:
  create:
    tags:
      - v*
  workflow_dispatch:

env:
  conda_version: 4.12.0
  conda_build_version: 3.24.0
jobs:
  set-anaconda-tag:
    runs-on: ubuntu-latest
    outputs:
      anaconda-tag: ${{ steps.anaconda-tag.outputs.tag }}
    steps:
    - name: Set Tag for Anaconda
      id: anaconda-tag
      run:
        if [[ $GITHUB_REF == 'refs/heads/master' ]]; then
          echo "tag=dev" >> $GITHUB_OUTPUT;
        elif [[ $GITHUB_REF =~ refs/tags/* ]]; then 
          echo "tag=main" >> $GITHUB_OUTPUT;
        fi
  build-windows:
    strategy:
      matrix:
        python_version: ['3.8', '3.9', '3.10', '3.11']

    runs-on: windows-2019

    steps:
    - uses: actions/checkout@v3
    - name: Add Conda
      uses: conda-incubator/setup-miniconda@v2
      with:
        auto-update-conda: true
        python-version: ${{ matrix.python_version }}
        conda-build-version: ${{ env.conda_build_version }}

    - name: Inspect Conda Environment
      run: |
       which python
       conda list
       conda info --all
    - name: Add scripts path
      run: echo "$env:CONDA\Scripts" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
    - name: Building...
      shell: cmd
      run: | 
        call conda build --no-build-id --python "${{ matrix.python_version }}" --output-folder channel recipe
    - name: Publishing artifact...
      uses: actions/upload-artifact@v3
      with:
        path: "channel/*/simpleitk*.tar.bz2"

  artifact-test:
    runs-on: windows-2019
    needs: build-windows
    strategy:
      matrix:
        python_version: ['3.8', '3.9', '3.10', '3.11']

    steps:
    - uses: actions/download-artifact@v3
    - name: Verify files
      run: |
        ls -LR artifact
      shell: bash
    - name: Add Conda
      uses: conda-incubator/setup-miniconda@v2
      with:
        auto-update-conda: true
        python-version: ${{ matrix.python_version }}
        conda-build-version: ${{ env.conda_build_version }}

    - name: Install Artifact
      run: |
        which python
        conda list
        conda info --all
        conda index artifact
        conda install --channel ./artifact simpleitk
    - name: Test
      run: |
        python -c "import SimpleITK; print(SimpleITK.__version__)"
